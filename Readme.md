# CTM Project

A Teacher Management System built with ASP.NET Core MVC for learning C# and modern web development.

## Tech Stack

- **Framework**: ASP.NET Core 9.0 MVC
- **Language**: C# 
- **Database**: PostgreSQL (Supabase)
- **ORM**: Entity Framework Core 9.0
- **Authentication**: ASP.NET Core Identity
- **Frontend**: Razor Pages, Bootstrap

## Project Setup

### 1. Create MVC Project

```bash
dotnet new mvc -n CTM -au Individual
cd CTM
```

### 2. Install Required Packages

```bash
dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL --version 9.0.2
dotnet add package Microsoft.EntityFrameworkCore.Tools
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore
```

**Note**: Since I only have .NET 9 installed, the package version must be specified to avoid compatibility issues with .NET 10 packages.

### 3. Configure Database Connection

Create `appsettings.Development.json` (this file is git-ignored for security):

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Host=aws-1-ap-northeast-2.pooler.supabase.com;Database=postgres;Username=postgres.[PROJECT_ID];Password=[YOUR_PASSWORD];Port=5432;SSL Mode=Require;Trust Server Certificate=true"
  },
  "Supabase": {
    "Url": "https://[PROJECT_ID].supabase.co",
    "Key": "[YOUR_ANON_KEY]"
  }
}
```

**Supabase Configuration Steps**:
1. Go to Supabase Dashboard → Settings → Database
2. Click **Connect** → Change method to **"Session Pooler"** (for IPv4 compatibility)
3. Copy the Session pooler connection string
4. Go to Settings → API Keys → Copy the **anon public** key

### 4. Update Program.cs

Replace SQLite with PostgreSQL in `Program.cs`:

```csharp
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection") 
    ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found.");

builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseNpgsql(connectionString));  // Changed from UseSqlite
    
builder.Services.AddDatabaseDeveloperPageExceptionFilter();
```

### 5. Database Migration

Install EF Core Tools globally:

```bash
dotnet tool install --global dotnet-ef
```

Create and apply initial migration:

```bash
dotnet ef migrations add InitialCreate
dotnet ef database update
```

### 6. Run the Application

```bash
dotnet run
```

The application will start at `http://localhost:5210` (or the port shown in your terminal).

### 7. Fetch Hong Kong School Data

The application automatically fetches school data from the Education Bureau's API on startup.

**API Source**: http://www.edb.gov.hk/attachment/en/student-parents/sch-info/sch-search/sch-location-info/SCH_LOC_EDB.json

**Files Created**:
- `Models/School.cs` - School entity model
- `Models/DTOs/EdbSchoolDto.cs` - DTO for parsing JSON from API
- `Services/SchoolDataService.cs` - Service to fetch and import school data

**Files Modified**:
- `Data/ApplicationDbContext.cs` - Added `DbSet<School>` 
- `Program.cs` - Registered `SchoolDataService` and added startup data seeding

**Steps**:

```bash
# Create migration for Schools table
dotnet ef migrations add AddSchoolTable

# Apply migration to database
dotnet ef database update

# Run application (will auto-import schools)
dotnet run
```

**Expected Output**:
```
info: CTM.Services.SchoolDataService[0]
      Successfully imported 3508 schools.
```

The service imports all schools (primary, secondary, kindergarten, special) from Hong Kong with fields:
- School Number
- English and Chinese Names
- District (for filtering)
- School Level (for filtering)


## Features (In Progress)

### Completed
- [x] Project initialization with ASP.NET Core Identity
- [x] Supabase PostgreSQL connection via connection pooling
- [x] EF Core migrations setup
- [x] User authentication (Register/Login) - auto-generated by Identity UI
- [x] Hong Kong school data import from Education Bureau API (3508+ schools)
- [x] School model with filtering support (District, School Level)

### Next Steps
- [ ] Student management (CRUD operations)
- [ ] Custom group/class management
- [ ] Link students to schools
- [ ] Score recording system
- [ ] Basic analytics and charts

## Project Structure

```
CTM/
├── Areas/Identity/              # ASP.NET Core Identity UI
├── Controllers/                 # MVC Controllers
├── Data/                        # DbContext and Migrations
│   ├── ApplicationDbContext.cs  # Main database context
│   └── Migrations/              # EF Core migration files
├── Models/                      # Entity models
│   ├── School.cs                # School entity
│   └── DTOs/                    # Data Transfer Objects
│       └── EdbSchoolDto.cs      # DTO for Education Bureau API
├── Services/                    # Business logic services
│   └── SchoolDataService.cs     # School data import service
├── Views/                       # Razor views
├── wwwroot/                     # Static files (CSS, JS, images)
├── Drafts/                      # Development notes and raw data
├── appsettings.json             # Public configuration (no secrets)
├── appsettings.Development.json # Local dev settings (git-ignored)
└── Program.cs                   # Application entry point
```
